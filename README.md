# Практическая работа спринт 8

## Задание 1 - PKCE

Запустить приложение:

```shell
docker-compose up
```

Для упрощения отладки с помощью Proxyman (или любого другого прокси) вместо localhost используется localhost.proxyman.io

Открыть клиентское приложение:
http://localhost.proxyman.io:3000/

Залогиниться:

- `user1` / `password123`

Чтобы разлогиниться есть кнопка Logout в состоянии авторизованного юзера.

Открыть админку keycloak:
http://localhost.proxyman.io:8080/

Запустив proxyman можно подтвердить что авторизация происходит с помощью PKCE.
Если же закомментировать App.keycloakInitOptions.pkceMethod, то будет получена ошибка клиентского приложения, так как
для Keycloak включено обязательное использование PKCE.

## Задача 2 - бэкенд-часть приложения для API

Запустить приложение:

```shell
docker-compose up
```

Открыть клиентское приложение:
http://localhost.proxyman.io:3000/

Залогиниться:

- `user1` / `password123`

Нажать кнопку Download Reports - будет ошибка (в devtools - networking смотреть), так как роль юзера не подходящая.

Разлогиниваемся через Logout.

Логиниться подходящей ролью:

- `prothetic1` / `prothetic123`

Теперь при нажатии на Download Reports успешно получим ответ сервера содержащий id юзера.

С помощью proxyman можно проверить корректность проверки подписи бекендом.

1. Поставить breakpoint на запрос http://localhost.proxyman.io:8000/reports
2. Нажать Download Reports в браузере
3. Сработает breakpoint - берем в нем данные JWT
4. Забираем среднюю часть JWT токена (она содержит данные)
5. Вставляем в https://www.base64decode.org и получаем json
6. Меняем значение (роль например на admin)
7. Вставляем новый json в https://www.base64encode.org
8. Забираем новый base64 и вставляем в JWT вместо старой средней части
9. Жмем выполнить запрос
10. В ответе получим 401, а в логах сервера увидим что проверка сигнатуры провалена

## Заметки

### npm start и кастомный домен

Если запускать приложение локально с помощью `npm start`, то работать будет только с доменом localhost.
Если же использовать http://localhost.proxyman.io:3000/ для проверки трафика - будет происходить постоянный редирект.
Поэтому для тестов локально лучше делать комбинацию:

```shell
npm run build
serve -s build
```

### iframe keycloak

Почему-то с включенным `checkLoginIframe` (он по умолчанию включен) инициализация не происходит вообще.

## Полезные ссылки

- https://blog.lunatech.com/posts/2023-06-07-kotlin-ktor-keycloak
- https://jwt.io
- https://stackoverflow.com/a/54526405
